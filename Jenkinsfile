pipeline {
    agent any  // ä½¿ç”¨Jenkinsé»˜è®¤çš„æ„å»ºèŠ‚ç‚¹ï¼ˆæœ¬åœ°æœåŠ¡å™¨ï¼‰
    
    stages {
        // --------------------------
        // é˜¶æ®µ1ï¼šæ‹‰å–ä»£ç ï¼ˆJenkinsè‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€é¢å¤–é…ç½®ï¼‰
        // --------------------------
        stage('Checkout Code') {
            steps {
                echo "å¼€å§‹ä»GitHubæ‹‰å–ä»£ç ..."
                git(
                    url: 'https://github.com/zhangping99/myflaskapp.git',  // ä½ çš„GitHubä»“åº“åœ°å€
                    branch: 'main',  // ä½ çš„åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯mainï¼‰
                    credentialsId: 'github-pat-zhangping99'  // ä½ çš„Jenkins GitHubå‡­æ®IDï¼ˆä¹‹å‰é…ç½®çš„PATï¼‰
                )
                echo "ä»£ç æ‹‰å–å®Œæˆï¼å½“å‰å·¥ä½œç›®å½•ï¼š${env.WORKSPACE}"  // æ‰“å°å·¥ä½œç›®å½•ï¼Œæ–¹ä¾¿æ’æŸ¥è·¯å¾„é—®é¢˜
            }
        }

        // --------------------------
        // é˜¶æ®µ2ï¼šå®‰è£…ä¾èµ–ï¼ˆç”¨ç³»ç»Ÿpipï¼Œå«ç‰ˆæœ¬éªŒè¯ï¼‰
        // --------------------------
        stage('Install Dependencies') {
            steps {
                bat '''
                    @echo off
                    echo ==============================================
                    echo éªŒè¯å½“å‰Python/pipç‰ˆæœ¬ï¼ˆç¡®ä¿ä¸ç³»ç»Ÿä¸€è‡´ï¼‰
                    echo ==============================================
                    python --version || (echo "âŒ Pythonå‘½ä»¤ä¸å¯ç”¨ï¼æ£€æŸ¥ç¯å¢ƒå˜é‡" && exit /b 1)
                    pip --version || (echo "âŒ pipå‘½ä»¤ä¸å¯ç”¨ï¼æ£€æŸ¥Pythonç¯å¢ƒå˜é‡" && exit /b 1)
                    
                    echo ==============================================
                    echo æ¸…ç†æ®‹ç•™Pythonè¿›ç¨‹ï¼ˆé¿å…æ–‡ä»¶/ç«¯å£å ç”¨ï¼‰
                    echo ==============================================
                    taskkill /f /im python.exe 2>nul || echo "âš ï¸  æœªæ‰¾åˆ°æ®‹ç•™Pythonè¿›ç¨‹ï¼Œç»§ç»­æ‰§è¡Œ"
                    
                    echo ==============================================
                    echo å‡çº§pipå¹¶å®‰è£…é¡¹ç›®ä¾èµ–
                    echo ==============================================
                    python -m pip install --upgrade pip --quiet || (echo "âŒ pipå‡çº§å¤±è´¥ï¼æ£€æŸ¥ç½‘ç»œæˆ–æƒé™" && exit /b 1)
                    pip install -r requirements.txt flake8 pytest coverage --quiet || (echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼æ£€æŸ¥requirements.txt" && exit /b 1)
                    
                    echo ==============================================
                    echo ä¾èµ–å®‰è£…å®Œæˆï¼å·²å®‰è£…çš„ä¾èµ–åˆ—è¡¨ï¼š
                    echo ==============================================
                    pip list | findstr /i "flask pytest flake8"  // ä»…æ˜¾ç¤ºå…³é”®ä¾èµ–ï¼ŒéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ
                '''
            }
        }

        // --------------------------
        // é˜¶æ®µ3ï¼šä»£ç é£æ ¼æ£€æŸ¥ï¼ˆflake8ï¼Œç¡®ä¿ä»£ç è§„èŒƒï¼‰
        // --------------------------
        stage('Code Lint (flake8)') {
            steps {
                bat '''
                    @echo off
                    echo ==============================================
                    echo æ‰§è¡Œä»£ç é£æ ¼æ£€æŸ¥ï¼ˆflake8ï¼‰
                    echo ==============================================
                    flake8 app.py tests/ || (
                        echo "âŒ ä»£ç é£æ ¼æ£€æŸ¥å¤±è´¥ï¼è¯·æ ¹æ®æ—¥å¿—ä¿®å¤ï¼ˆå¦‚ç©ºè¡Œã€ç¼©è¿›é—®é¢˜ï¼‰"
                        exit /b 1  // æ£€æŸ¥å¤±è´¥åˆ™ç»ˆæ­¢æµç¨‹ï¼Œé¿å…åç»­æ— æ•ˆæ‰§è¡Œ
                    )
                    echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡ï¼æ— PEP8é”™è¯¯"
                '''
            }
        }

        // --------------------------
        // é˜¶æ®µ4ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆpytestï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸ï¼‰
        // --------------------------
        stage('Run Tests (pytest)') {
            steps {
                bat '''
                    @echo off
                    echo ==============================================
                    echo æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆpytestï¼‰å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
                    echo ==============================================
                    pytest --cov=app tests/ --cov-report=html || (
                        echo "âŒ è‡ªåŠ¨åŒ–æµ‹è¯•å¤±è´¥ï¼è¯·æ£€æŸ¥æµ‹è¯•ç”¨ä¾‹æˆ–ä»£ç é€»è¾‘"
                        exit /b 1
                    )
                    echo "âœ… è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡ï¼æ‰€æœ‰ç”¨ä¾‹æ‰§è¡ŒæˆåŠŸ"
                '''
            }
            // æµ‹è¯•å®Œæˆåï¼Œåœ¨Jenkinsä¸­å±•ç¤ºè¦†ç›–ç‡æŠ¥å‘Šï¼ˆéœ€å®‰è£…HTML Publisheræ’ä»¶ï¼‰
            post {
                always {
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: 'htmlcov',  // è¦†ç›–ç‡æŠ¥å‘Šç›®å½•ï¼ˆpytestè‡ªåŠ¨ç”Ÿæˆï¼‰
                        reportFiles: 'index.html',
                        reportName: 'Test Coverage Report'  // Jenkinsä¸­æ˜¾ç¤ºçš„æŠ¥å‘Šåç§°
                    ])
                }
            }
        }

        // --------------------------
        // é˜¶æ®µ5ï¼šéƒ¨ç½²åº”ç”¨ï¼ˆè°ƒç”¨deploy.batï¼Œåå°å¯åŠ¨Flaskï¼‰
        // --------------------------
        stage('Deploy Application') {
            steps {
                bat '''
                    @echo off
                    echo ==============================================
                    echo æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆdeploy.batï¼‰
                    echo ==============================================
                    if not exist "deploy.bat" (
                        echo "âŒ éƒ¨ç½²è„šæœ¬deploy.batä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•"
                        exit /b 1
                    )
                    call deploy.bat || (
                        echo "âŒ éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼è¯·æŸ¥çœ‹deploy.batæ—¥å¿—"
                        exit /b 1
                    )
                    echo "âœ… åº”ç”¨éƒ¨ç½²å®Œæˆï¼è®¿é—®åœ°å€ï¼šhttp://localhost:5000"
                '''
            }
        }
    }

    // --------------------------
    // å…¨å±€æ„å»ºç»“æœï¼šæˆåŠŸ/å¤±è´¥æç¤ºï¼ˆå¯é€‰ï¼šæ·»åŠ é‚®ä»¶é€šçŸ¥ï¼‰
    // --------------------------
    post {
        success {
            echo "ğŸ‰ å…¨æµç¨‹CI/CDæ‰§è¡ŒæˆåŠŸï¼"
            // ï¼ˆå¯é€‰ï¼‰æ·»åŠ é‚®ä»¶é€šçŸ¥ï¼Œéœ€å…ˆé…ç½®Jenkinsé‚®ä»¶æ’ä»¶
            // emailext to: 'your-email@xxx.com', subject: 'Jenkinsæ„å»ºæˆåŠŸ', body: 'åº”ç”¨å·²éƒ¨ç½²åˆ°http://localhost:5000'
        }
        failure {
            echo "âŒ å…¨æµç¨‹CI/CDæ‰§è¡Œå¤±è´¥ï¼è¯·æŸ¥çœ‹å„é˜¶æ®µæ—¥å¿—æ’æŸ¥é—®é¢˜"
            // ï¼ˆå¯é€‰ï¼‰å¤±è´¥æ—¶å‘é€é‚®ä»¶é€šçŸ¥
            // emailext to: 'your-email@xxx.com', subject: 'Jenkinsæ„å»ºå¤±è´¥', body: 'å¤±è´¥æ—¥å¿—ï¼š${BUILD_URL}console'
        }
    }
}